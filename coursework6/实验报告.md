# 嵌入式软件开发与工具实验报告

## 综合应用实验

第一组 组员：李普，李娟，卢意

### 一、实验目的

能够综合应用课程所学的技术与工具，包括：

+ socket通信

+ 多进程、多线程编程

+ 交叉调试目标端程序

+ 磁盘分区与文件系统创建

+ 模块与驱动编程

### 二、实验内容

1. 将树莓派设为智能家居Linux服务器，可用来采集并维护环境数据，如PM2.5、温度、湿度、气味、电器状态数据等。在实际环境中数据来自相应的传感器，本次试验中用scull设备模拟。有条件的小组鼓励使用真实设备采集数据。

2. 要求创建2个以上的scull设备，设备驱动可选择从内核源码树外(Kbuild)编译安装，或加入到内核源码树内。 驱动函数要求包括： open, release, read, write, llseek, ioctl。

3. 实验中的环境数据存储在特定文件系统中。该文件系统要求具备属性： 在线写入、 持久性、 断电可靠性。

4. PC机、移动设备或另外一个树莓派用作远程客户端，随时请求获取环境数据，客户端和服务器之间采用Socket通信。

5. APP编译采用交叉编译，用gdb-gdbserver交叉调试APP。

### 三、实验过程及结果

#### 1、scull设备安装与应用

#### 2、文件系统创建

#### 3、socket通信

以树莓派做服务器，PC机作为远程客户端，PC机可以随时向树莓派发送请求获取环境数据，采用TCP协议通信的socket编程，交互流程如下图：

![socket](https://github.com/SpursLipu/Embedded-software-development-technology-and-tools-/blob/master/coursework6/images/socket.png)

树莓派服务器端流程为：

- 创建套接字

- 确定服务器ip地址和端口号，绑定套接字

- 监听对应的端口号

- 接收来自客户端的请求，每个请求会创建新的套接字来处理，原套接字会继续等待处理新的请求

- 创建子进程处理单个请求，这样可以实现并行处理请求

- 子进程中，读取客户端命令，并向客户端发送反馈

- 关闭套接字

PC机客户端流程为：

- 创建套接字

- 确定服务器ip地址和端口号，向服务器发送连接请求

- 连接成功后，向服务器发送请求环境参数的命令

- 接收来自服务器的反馈内容

- 关闭套接字

一个服务器端可以同时连接多个客户端，为了提高服务器端处理每个连接的效率，采用多进程的方式。父进程为原套接字等待处理客户端连接请求，每创建一个新的C/S连接，都创建一个子进程处理该连接的任务，如下图：

![multiprocess](https://github.com/SpursLipu/Embedded-software-development-technology-and-tools-/blob/master/coursework6/images/multiprocess.png)

实际运行效果如图：

图片链接

服务器和客户端连接成功后，客户端通过write()函数向服务器发送请求环境参数的请求，服务器通过read()函数接收请求，并确定请求是否正确，如果正确，就从文件系统中存储环境参数的文件当中读取环境参数发送给客户端。



#### 4、交叉编译与调试

### 四、实验总结

### 五、实验源码






